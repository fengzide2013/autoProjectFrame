package com.shunwang.autoProjectFrame.fileProducer;

import java.util.ArrayList;
import java.util.List;

import com.shunwang.autoProjectFrame.constrain.Field;
import com.shunwang.autoProjectFrame.constrain.Table;

public class SqlMapFileProducer extends FileProducer {

	public SqlMapFileProducer(Table table, String directory) {
		super(table, directory);
	}

	@Override
	public List<String> createFileContent() {
		List<String> listString = new ArrayList<String>();
		listString.add(createHeaderStr());
		listString.add(createSqlMapStr());
		listString.add(createResultMapStr());
		listString.add(createFindStr());
		if(table.getPrimaryKeys().size()==1){
			listString.add(createGetStr());
		}
		listString.add(createDeleteStr());
		listString.add(createInsertStr());
		listString.add(createFindCntStr());
		listString.add(StringUpdateStr());

		return listString;
	}

	@Override
	public String createFilePath() {
		return directory+"\\"+ table.getSimpleTableName() + "_sqlMap.xml";
	}
	private String createFullClassName(){
		return table.getPackageName()+".pojo."+table.getClassName();
	}
	private String createHeaderStr(){
		return "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"+
				"<!DOCTYPE sqlMap PUBLIC \"-//ibatis.apache.org//DTD SQL Map 2.0//EN\" \"http://ibatis.apache.org/dtd/sql-map-2.dtd\" >";
	}
	private String createSqlMapStr(){
		return "<sqlMap namespace=\""+createFullClassName()+"\">";
	}
	private String createResultMapStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("<resultMap class=\""+createFullClassName()+"\" id=\"BaseResultMap\">\n");
		List<Field> listField = table.getListField();
		for(Field field:listField){
			String property = field.getProperty();
			String fieldName = field.getFieldName();
			String jdbcType = field.getJdbcType();
			sb.append("	<result property=\""+property+"\" column=\""+fieldName+"\" jdbcType=\""+jdbcType+"\"/>\n");
		}
		sb.append("</resultMap>");
		return sb.toString();
	}
	private String createFindStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("	<select id=\"find\" resultMap=\"BaseResultMap\" parameterClass=\"com.shunwang.framework.ibatis.query.ConditionQuery\" >\n");
		sb.append("		<isNotEqual property=\"rp\" compareValue=\"0\" >\n");
		sb.append("			SELECT t0.* FROM (\n");
		sb.append("		</isNotEqual>\n");
		sb.append("		select row_number() over(order by\n");
		sb.append("		<isNotNull property=\"orderCol\" >\n");
		sb.append("			$orderCol$\n");
		sb.append("		</isNotNull>\n");
		sb.append("		<isNull property=\"orderCol\" >\n");
		String temp = convertPrimaryKeysToStr();
		if(temp!=null&&!"".equals(temp)){
			sb.append("			"+temp+" desc\n");
		}else{
			sb.append("			"+table.getListField().get(0).getFieldName()+" desc\n");
		}
		sb.append("		</isNull>\n");
		sb.append("		) row,\n"+converAllFieldToStr("t.")+"		from "+table.getTableName()+" t \n");
		sb.append("		<isParameterPresent >\n");
		sb.append("			<include refid=\"Example_Where_Clause\" />\n");
		sb.append("		</isParameterPresent>\n");
		sb.append("		<isNotEqual property=\"rp\" compareValue=\"0\" >\n");
		sb.append("			) t0 WHERE t0.row BETWEEN (#firstResult:INTEGER#+1) AND (#firstResult:INTEGER#+#rp:INTEGER#)\n");
		sb.append("		</isNotEqual>\n");
		sb.append("	</select>");

		return sb.toString();
	}
	private String convertPrimaryKeysToStr(){
		List<String> primaryKeys = table.getPrimaryKeys();
		StringBuffer sb = new StringBuffer();
		for(String str:primaryKeys){
			sb.append(str+",");
		}
                if(sb.length()>0)
		sb.deleteCharAt(sb.length()-1);
		return sb.toString();
	}
	private String converAllFieldToStr(String prex){
		List<Field> listField = table.getListField();
		StringBuffer sb = new StringBuffer();
		for(Field field:listField){
			sb.append("		"+prex+field.getFieldName()+",\n");
		}
		sb.deleteCharAt(sb.length()-2);
		return sb.toString();
	}
	private String createGetStr(){
		String fieldName = table.getPrimaryKeys().get(0);
		Field field = getField(fieldName);
		StringBuffer sb = new StringBuffer();
		sb.append("	<select id=\"get\" resultMap=\"BaseResultMap\" parameterClass=\""+field.getJavaType()+"\" >\n");
		sb.append("		select\n"+converAllFieldToStr(""));
		sb.append("		from "+table.getTableName()+"\n");
		sb.append("		where "+fieldName+" = #value#\n");
		sb.append("	 </select>");
		return sb.toString();
	}
	private String createDeleteStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("	<delete id=\"delete\" parameterClass=\""+createFullClassName()+"\" >\n");
		sb.append("		delete from "+table.getTableName()+" where 1=1 \n");
		List<String>  primaryKeys = table.getPrimaryKeys();
		if(primaryKeys.size()!=0){
			for(String str:primaryKeys){
				Field field = getField(str);
				sb.append("			and "+field.getFieldName()+"=#"+field.getProperty()+":"+field.getJdbcType()+"#\n");
			}
		}else{
			List<Field> listField = table.getListField();
			for(Field field:listField){
				sb.append("			and "+field.getFieldName()+"=#"+field.getProperty()+":"+field.getJdbcType()+"#\n");
			}
		}
		sb.append("	</delete>");
		return sb.toString();
	}
	private Field getField(String fieldName){
		List<Field> listField = table.getListField();
		Field field = null;
		for(Field tempField:listField){
			if(fieldName.equals(tempField.getFieldName()))
				 field=tempField;
		}
		return field;
	}
	private String createInsertStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("	<insert id=\"insert\" parameterClass=\""+createFullClassName()+"\" >\n");
		sb.append("		insert into "+table.getTableName()+" (\n");
		String fieldStr =converAllFieldToStr("");
		String valuesSetStr = createValuesSetStr();
		List<String> primaryKeys = table.getPrimaryKeys();
		Field field = null;
		if(primaryKeys.size()==1){
		 field = getField(table.getPrimaryKeys().get(0));
		}
		if(field!=null&&field.isAutoIncrement()){
			fieldStr = fieldStr.replaceAll("		"+field.getFieldName()+"[,]?\n", "");
			if(fieldStr.endsWith(",\n"))
			fieldStr = fieldStr.substring(0, fieldStr.lastIndexOf(","));
			valuesSetStr = valuesSetStr.replaceAll("		#"+field.getProperty()+":"+field.getJdbcType()+"#[,]?\n", "");
			if(valuesSetStr.endsWith(",\n"))
			valuesSetStr = valuesSetStr.substring(0, valuesSetStr.lastIndexOf(","));
			sb.append(fieldStr);
			sb.append("		)\n");
			sb.append("		values(\n");
			sb.append(valuesSetStr);
			sb.append("		)\n");
			sb.append("		<selectKey resultClass=\"java.lang.Integer\" keyProperty=\""+field.getProperty()+"\" >\n");
			sb.append("		SELECT  @@IDENTITY\n");
			sb.append("		</selectKey>\n");
			sb.append("	</insert>");
		}else{
			sb.append(fieldStr);
			sb.append("		)\n");
			sb.append("		values(\n");
			sb.append(valuesSetStr);
			sb.append("		)\n");
			sb.append("	</insert>");
		}
		return sb.toString();
	}
	private String createValuesSetStr(){
		List<Field> listField = table.getListField();
		StringBuffer sb = new StringBuffer();
		for(Field field:listField){
			sb.append("		#"+field.getProperty()+":"+field.getJdbcType()+"#,\n");
		}
		sb.deleteCharAt(sb.length()-2);
		return sb.toString();
	}
	private String createFindCntStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("	<select id=\"findCnt\" parameterClass=\"com.shunwang.framework.ibatis.query.ConditionQuery\" resultClass=\"java.lang.Integer\" >\n");
		sb.append("		select count(*) from "+table.getTableName()+" t\n");
		sb.append("		<include refid=\"Example_Where_Clause\" />\n");
		sb.append("	</select>");
		return sb.toString();
	}
	private String StringUpdateStr(){
		StringBuffer sb = new StringBuffer();
		sb.append("	<update id=\"update\" parameterClass=\""+createFullClassName()+"\" >\n");
		sb.append("		update "+table.getTableName()+" set\n");
		String valuesEqualStr = createValuesEqualStr();
		String whereStr = "\n		where 1=1 ";
		List<String> primaryKeys = table.getPrimaryKeys();
		if(primaryKeys.size()>0){
			for(String fieldName:primaryKeys){
				Field field = getField(fieldName);
				valuesEqualStr = valuesEqualStr.replaceAll("		"+field.getFieldName()+" = #"+field.getProperty()+":"+field.getJdbcType()+"#[,]?\n", "");
				if(valuesEqualStr.endsWith(",\n"))
				valuesEqualStr = valuesEqualStr.substring(0, valuesEqualStr.lastIndexOf(","));
				whereStr = whereStr+" and "+field.getFieldName()+" = #"+field.getProperty()+":"+field.getJdbcType()+"#";
			}
		}
		sb.append(valuesEqualStr);
		sb.append(whereStr+"\n");
		sb.append("	</update>\n");
		sb.append("</sqlMap>");
		return sb.toString();
	}
	private String createValuesEqualStr(){
		List<Field> listField = table.getListField();
		StringBuffer sb = new StringBuffer();
		for(Field field:listField){
			sb.append("		"+field.getFieldName()+" = #"+field.getProperty()+":"+field.getJdbcType()+"#,\n");
		}
		sb.deleteCharAt(sb.length()-2);
		return sb.toString();
	}
}
